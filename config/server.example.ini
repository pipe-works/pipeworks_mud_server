# =============================================================================
# PipeWorks MUD Server Configuration
# =============================================================================
#
# Copy this file to server.ini and customize for your deployment.
# DO NOT commit server.ini to version control (it contains deployment secrets).
#
# Configuration Priority (highest wins):
#   1. Environment variables (MUD_* prefix)
#   2. This config file (config/server.ini)
#   3. Built-in defaults
#
# Environment Variable Mapping:
#   [server] host          -> MUD_HOST
#   [server] port          -> MUD_PORT
#   [security] production  -> MUD_PRODUCTION
#   [security] cors_origins -> MUD_CORS_ORIGINS
#   [session] ttl_minutes  -> MUD_SESSION_TTL_MINUTES
#   [session] sliding_expiration -> MUD_SESSION_SLIDING_EXPIRATION
#   [session] allow_multiple_sessions -> MUD_SESSION_ALLOW_MULTIPLE
#   [worlds] worlds_root   -> MUD_WORLDS_ROOT
#   [worlds] default_world_id -> MUD_DEFAULT_WORLD_ID
#   [worlds] allow_multi_world_characters -> MUD_ALLOW_MULTI_WORLD_CHARACTERS
#   [registration] account_registration_mode -> MUD_REGISTRATION_MODE
#   [registration] guest_registration_enabled -> MUD_GUEST_REGISTRATION_ENABLED
#   [character_creation] player_self_create_enabled -> MUD_PLAYER_SELF_CREATE_ENABLED
#   [character_creation] default_creation_mode -> MUD_CHAR_CREATE_DEFAULT_MODE
#   [character_creation] default_naming_mode -> MUD_CHAR_CREATE_DEFAULT_NAMING
#   [character_creation] default_world_slot_limit -> MUD_CHAR_CREATE_DEFAULT_SLOT_LIMIT
#   [integrations] entity_state_enabled -> MUD_ENTITY_STATE_ENABLED
#   [integrations] entity_state_base_url -> MUD_ENTITY_STATE_BASE_URL
#   [integrations] entity_state_timeout_seconds -> MUD_ENTITY_STATE_TIMEOUT_SECONDS
#   [integrations] entity_state_include_prompts -> MUD_ENTITY_STATE_INCLUDE_PROMPTS
#   [integrations] namegen_enabled -> MUD_NAMEGEN_ENABLED
#   [integrations] namegen_base_url -> MUD_NAMEGEN_BASE_URL
#   [integrations] namegen_timeout_seconds -> MUD_NAMEGEN_TIMEOUT_SECONDS
#   [ollama_translation] enabled           -> MUD_TRANSLATION_ENABLED
#   [ollama_translation] base_url          -> MUD_TRANSLATION_OLLAMA_URL
#   [ollama_translation] timeout_seconds   -> MUD_TRANSLATION_TIMEOUT
#   [database] path        -> MUD_DB_PATH
#
# =============================================================================


# -----------------------------------------------------------------------------
# SERVER SETTINGS
# -----------------------------------------------------------------------------
# Network configuration for the FastAPI backend server.
# The admin WebUI is served by the API at /admin.
# -----------------------------------------------------------------------------

[server]

# Network interface to bind to
# - 0.0.0.0     : Accept connections from any interface (default, use for production)
# - 127.0.0.1   : Accept only local connections (development/testing)
# - <specific>  : Bind to a specific network interface IP
host = 0.0.0.0

# TCP port for the API server
# - Default: 8000
# - If port is in use, server will auto-discover next available (8000-8099)
# - Set MUD_PORT env var or use --port CLI flag to override
port = 8000


# -----------------------------------------------------------------------------
# SECURITY SETTINGS
# -----------------------------------------------------------------------------
# Security controls including CORS, API documentation, and production mode.
# These settings are critical for protecting your server in production.
# -----------------------------------------------------------------------------

[security]

# Production mode toggle
# When true:
#   - API documentation (/docs, /redoc) is disabled by default
#   - Stricter security defaults are applied
#   - More detailed error messages are hidden from clients
# When false:
#   - Development-friendly settings (docs enabled, verbose errors)
#
# IMPORTANT: Set to true for any internet-facing deployment!
# Override: MUD_PRODUCTION=true
production = false

# CORS (Cross-Origin Resource Sharing) allowed origins
# Comma-separated list of origins that can make requests to this API.
#
# SECURITY WARNING:
#   - NEVER use "*" in production with allow_credentials=true
#   - Only list domains you control
#   - Include protocol (http:// or https://)
#
# Examples:
#   Development: http://localhost:8000, http://127.0.0.1:8000
#   Production:  https://yourdomain.com, https://api.yourdomain.com
#
# Override: MUD_CORS_ORIGINS=https://site1.com,https://site2.com
cors_origins = http://localhost:8000, http://127.0.0.1:8000

# Allow credentials (cookies, authorization headers) in CORS requests
# - true  : Required for session-based auth across origins
# - false : More restrictive, use if you don't need cross-origin auth
#
# SECURITY NOTE: When true, cors_origins cannot be "*" (wildcard)
cors_allow_credentials = true

# Allowed HTTP methods for CORS
# Comma-separated list. Common values: GET, POST, PUT, DELETE, OPTIONS
# Use "*" to allow all methods (acceptable since origins are restricted)
cors_allow_methods = *

# Allowed HTTP headers for CORS
# Comma-separated list. Use "*" to allow all headers.
# Specific headers: Content-Type, Authorization, X-Requested-With
cors_allow_headers = *

# API Documentation endpoints (/docs and /redoc)
# - auto     : Follows production setting (disabled in production, enabled otherwise)
# - enabled  : Always show docs (useful for internal APIs even in production)
# - disabled : Never show docs (maximum security)
#
# NOTE: Even when enabled, consider restricting access via nginx/firewall
docs_enabled = auto


# -----------------------------------------------------------------------------
# SESSION SETTINGS
# -----------------------------------------------------------------------------
# Player session management configuration.
# Sessions track logged-in users and their authentication state.
# -----------------------------------------------------------------------------

[session]

# Session time-to-live (TTL) in minutes
# Sessions expire after this period of inactivity.
# 8 hours = 480 minutes (default for dev example)
#
# Override: MUD_SESSION_TTL_MINUTES=480
ttl_minutes = 480

# Sliding expiration
# When true, each validated request extends the session expiry by ttl_minutes.
# When false, sessions expire at a fixed time since login.
#
# Override: MUD_SESSION_SLIDING_EXPIRATION=true
sliding_expiration = true

# Active window for "online" status (minutes)
# Sessions are considered active if last_activity is within this window.
# Override: MUD_SESSION_ACTIVE_WINDOW_MINUTES=30
active_window_minutes = 30

# Allow multiple concurrent sessions per user
# true  = same user can log in from multiple devices
# false = new login invalidates previous sessions for that user
#
# Override: MUD_SESSION_ALLOW_MULTIPLE=true
allow_multiple_sessions = true


# -----------------------------------------------------------------------------
# CHARACTER SETTINGS
# -----------------------------------------------------------------------------
# Character slot limits and defaults.
# -----------------------------------------------------------------------------

[characters]

# Default number of character slots granted to new accounts
default_slots = 2

# Maximum number of character slots allowed per account
max_slots = 10


# -----------------------------------------------------------------------------
# REGISTRATION POLICY
# -----------------------------------------------------------------------------
# Account registration controls for self-service signup endpoints.
# -----------------------------------------------------------------------------

[registration]

# Account registration mode:
# - open   : /register allows creating new account records.
# - closed : /register is disabled (admin-created accounts only).
#
# NOTE: /register-guest is controlled separately below.
account_registration_mode = open

# Guest registration toggle:
# - true  : /register-guest is available.
# - false : /register-guest returns an explicit policy error.
guest_registration_enabled = true


# -----------------------------------------------------------------------------
# CHARACTER CREATION POLICY
# -----------------------------------------------------------------------------
# Global defaults for player self-service character provisioning.
# World-specific overrides can be defined via [world_policy.<world_id>].
# -----------------------------------------------------------------------------

[character_creation]

# Allow authenticated players to call self-service character creation APIs.
# - true  : players can create characters (subject to world policy).
# - false : only admin/superuser character provisioning is allowed.
player_self_create_enabled = true

# Default world creation mode for worlds without explicit overrides:
# - open   : account holders can create in-world characters without invite grants
# - invite : world_permissions.can_access=1 is required for creation
default_creation_mode = invite

# Default naming mode for worlds without explicit overrides:
# - generated : server mints deterministic names from name generation service
# - manual    : reserved for admin/superuser flows in this phase
default_naming_mode = generated

# Default per-world character slot limit per account.
# Slot accounting is scoped by (user_id, world_id).
default_world_slot_limit = 10


# -----------------------------------------------------------------------------
# WORLD SETTINGS
# -----------------------------------------------------------------------------
# Multi-world configuration and defaults.
# -----------------------------------------------------------------------------

[worlds]

# Root directory containing world packages.
# Each world should live at: <worlds_root>/<world_id>/world.json
#
# Override: MUD_WORLDS_ROOT=/path/to/data/worlds
worlds_root = data/worlds

# Default world used when a world_id is not provided by legacy API calls.
#
# Override: MUD_DEFAULT_WORLD_ID=pipeworks_web
default_world_id = pipeworks_web

# Allow characters for a single user to exist in multiple worlds.
# Default false to keep the early experience simple.
#
# Override: MUD_ALLOW_MULTI_WORLD_CHARACTERS=true
allow_multi_world_characters = false


# -----------------------------------------------------------------------------
# WORLD-SPECIFIC CHARACTER POLICY OVERRIDES
# -----------------------------------------------------------------------------
# Use [world_policy.<world_id>] to override creation mode, naming mode, and
# slot limits for specific worlds.
#
# Temporary rollout note:
# - naming_mode=manual remains admin/superuser-only for now.
# - Player self-service naming should remain generated until role-aware naming
#   UX/permissions are finalized for broader deployments.
# -----------------------------------------------------------------------------

[world_policy.pipeworks_web]

# PipeWorks Web is the default open onboarding world.
creation_mode = open

# Character names are generated by the server for this world.
naming_mode = generated

# Initial world-tied slot budget for iterative testing.
slot_limit_per_account = 10


# -----------------------------------------------------------------------------
# INTEGRATIONS
# -----------------------------------------------------------------------------
# External service integrations used during onboarding and content generation.
# -----------------------------------------------------------------------------

[integrations]

# Enable entity-state bootstrap during guest account registration.
# When enabled, /register-guest calls the entity API and returns the generated
# payload to the client as part of the registration response.
entity_state_enabled = true

# Public base URL of the entity-state API (no trailing slash required).
entity_state_base_url = https://entity.pipe-works.org

# Request timeout (seconds) for entity-state calls.
entity_state_timeout_seconds = 3.0

# Include prompt strings from the entity API.
# Keep false for lean payloads unless the client explicitly needs prompts.
entity_state_include_prompts = false

# Enable name generation integration for automated character provisioning.
# When enabled, admin character creation can request names from name.api.
namegen_enabled = true

# Public base URL of the name generation API.
namegen_base_url = https://name.api.pipe-works.org

# Request timeout (seconds) for name generation calls.
namegen_timeout_seconds = 3.0


# -----------------------------------------------------------------------------
# DATABASE SETTINGS
# -----------------------------------------------------------------------------
# SQLite database configuration.
# The database stores players, sessions, chat messages, and game state.
# -----------------------------------------------------------------------------

[database]

# Path to the SQLite database file
# - Relative paths are relative to the project root
# - Absolute paths are used as-is
# - Directory must exist (file is created automatically)
#
# Override: MUD_DB_PATH=/path/to/mud.db
path = data/mud.db


# -----------------------------------------------------------------------------
# LOGGING SETTINGS
# -----------------------------------------------------------------------------
# Application logging configuration.
# Logs are written to both console and files in the logs/ directory.
# -----------------------------------------------------------------------------

[logging]

# Minimum log level to record
# Levels (least to most verbose): CRITICAL, ERROR, WARNING, INFO, DEBUG
# - CRITICAL : Only fatal errors
# - ERROR    : Errors that need attention
# - WARNING  : Potential issues (recommended for production)
# - INFO     : General operational messages (recommended for staging)
# - DEBUG    : Detailed debugging info (development only, verbose!)
#
# Override: MUD_LOG_LEVEL=DEBUG
level = INFO

# Log format
# - simple   : "LEVEL: message"
# - detailed : "TIMESTAMP - NAME - LEVEL - message"
# - json     : JSON structured logging (for log aggregation systems)
#
# NOTE: json format not yet implemented
format = detailed


# -----------------------------------------------------------------------------
# RATE LIMITING SETTINGS
# -----------------------------------------------------------------------------
# Application-level rate limiting (supplements nginx rate limiting).
# These are fallback limits if nginx is bypassed or for internal deployments.
# -----------------------------------------------------------------------------

[rate_limit]

# Enable application-level rate limiting
# - true  : Enforce limits below
# - false : Rely solely on nginx/reverse proxy for rate limiting
#
# NOTE: Not yet implemented - nginx handles this currently
enabled = false

# Login attempts per minute per IP
# Helps prevent brute-force password attacks
login_per_minute = 5

# Registration attempts per minute per IP
# Helps prevent automated account creation
register_per_minute = 5

# General API requests per second per session
# Prevents abuse of authenticated endpoints
api_per_second = 30


# -----------------------------------------------------------------------------
# FEATURE FLAGS
# -----------------------------------------------------------------------------
# Toggle experimental or optional features.
# Use these to enable/disable functionality without code changes.
# -----------------------------------------------------------------------------

[features]

# Enable Ollama AI integration
# When false, the /admin/ollama/* endpoints return "feature disabled"
#
# NOTE: Not yet implemented as a toggle
ollama_enabled = true

# Enable detailed error messages in API responses
# - true  : Include stack traces and internal details (development)
# - false : Generic error messages only (production)
#
# SECURITY: Set to false in production to avoid information leakage
verbose_errors = false


# -----------------------------------------------------------------------------
# OLLAMA TRANSLATION SETTINGS
# -----------------------------------------------------------------------------
# Server-level controls for the OOC→IC translation layer.
#
# The translation layer renders raw player/NPC chat through a locally-hosted
# LLM (via Ollama) before storing the message, using the character's current
# axis profile to shape the voice.  It is non-authoritative: it never affects
# axis scores, ledger state, or game mechanics — only the stored dialogue text.
#
# Two-level switch:
#   1. This section's `enabled` is the MASTER switch.  Set to false to disable
#      translation globally across all worlds regardless of world.json config.
#   2. Each world's `translation_layer.enabled` in world.json is the per-world
#      switch.  Both must be true for translation to activate for a world.
#
# To enable for a world:
#   1. Ensure enabled = true here (it is, by default).
#   2. Set "translation_layer": {"enabled": true} in the world's world.json.
#   3. Run Ollama locally: `ollama serve` with `ollama pull gemma2:2b`.
# -----------------------------------------------------------------------------

[ollama_translation]

# Master switch for the translation layer across all worlds.
# - true  : Per-world config in world.json controls whether translation runs.
# - false : Translation is disabled globally; world.json settings are ignored.
#
# Override: MUD_TRANSLATION_ENABLED=false
enabled = true

# Base URL of the Ollama instance.
# Individual world packages may override this with their own ollama_base_url
# setting in world.json.  This value acts as the server-level default.
#
# Override: MUD_TRANSLATION_OLLAMA_URL=http://remote-host:11434
base_url = http://localhost:11434

# Default HTTP request timeout (seconds) for Ollama translation calls.
# On expiry the system falls back to the original OOC message; gameplay
# continues uninterrupted.  World packages may override this individually.
#
# Override: MUD_TRANSLATION_TIMEOUT=10.0
timeout_seconds = 10.0
